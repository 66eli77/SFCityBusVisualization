<!DOCTYPE html>
<html lang='en'>
    <head>
        <meta charset='utf-8'>
        <title>SF City Bus Map</title>
    </head>
    <style type='text/css'>
        body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            background-color: #acc0e0;
        }
    </style>
    <body>
        <script src='http://d3js.org/d3.v4.min.js'></script>
        <script src='http://d3js.org/queue.v1.min.js'></script>
        <script type='text/javascript'>
            var width = window.innerWidth - 10,
                height = window.innerHeight - 10;

            var url = 'http://webservices.nextbus.com/service/publicXMLFeed?command=vehicleLocations&a=sf-muni&t=0';

            var svg = d3.select('body').append('svg')
                .attr('width', width)
                .attr('height', height)
                .attr('class', 'svg');

            queue()
                .defer(d3.json, 'sfmaps/neighborhoods.json')
                .defer(d3.json, 'sfmaps/streets.json')
                .defer(d3.json, 'sfmaps/freeways.json')
                .defer(d3.json, 'sfmaps/arteries.json')
                .defer(d3.xml, url)
                .await(makeMap);

            // load geojson and do stuff in a callback function...
            function makeMap(error, neighborhoods, streets, freeways, arteries, buses){
                // create a unit projection
                var projection = d3.geoAlbers()
                    .scale(1)
                    .translate([0,0]);

                // create a path generator.
                var path = d3.geoPath().projection(projection);

                // compute bounds of a point of interest, then derive scale and translate
                var b = path.bounds(neighborhoods),
                    s = .95 / Math.max((b[1][0] - b[0][0]) / width, (b[1][1] - b[0][1]) / height),
                    t = [(width - s * (b[1][0] + b[0][0])) / 2, (height - s * (b[1][1] + b[0][1])) / 2];

                // update the projection to use computed scale and translate....
                projection.scale(s).translate(t);

                // draw the neighborhoods
                const districts = svg.selectAll('path').data(neighborhoods.features).enter().append('path')
                    .attr('d', path)
                    .style('fill', '#fcdfdb')
                    .style('stroke-width', '1')
                    .style('stroke', 'orange');

                // draw the streets
                svg.selectAll('path').data(streets.features).enter().append('path')
                    .attr('d', path)
                    .style('fill', 'transparent')
                    .style('stroke-width', '0.5')
                    .style('stroke', 'green');

                // draw the arteries
                svg.selectAll('LineString').data(arteries.features).enter().append('path')
                    .attr('d', path)
                    .style('fill', 'transparent')
                    .style('stroke-width', '2')
                    .style('stroke', '#4286f4');

                // draw the freeways
                svg.selectAll('LineString').data(freeways.features).enter().append('path')
                    .attr('d', path)
                    .style('fill', 'transparent')
                    .style('stroke-width', '3')
                    .style('stroke', '#82d85d');

                // draw the buses
                const fleet = svg.selectAll('.bus').data(buses.documentElement.getElementsByTagName('vehicle'), d => d.getAttribute('id')).enter().append('circle')
                    .attr('cx', d => projection([d.getAttribute('lon'), d.getAttribute('lat')])[0])
                    .attr('cy', d => projection([d.getAttribute('lon'), d.getAttribute('lat')])[1])
                    .attr('r', 3)
                    .attr('id', d => d.getAttribute('id'))
                    .attr('class', 'bus')
                    .style('fill', 'red');

                // update the buses every 15 secs
                setInterval(() => {
                    d3.xml(url, xml => {
                        fleet.data(xml.documentElement.getElementsByTagName('vehicle'), d => d.getAttribute('id'))
                            .transition().duration(3000).ease(d3.easeSin)
                            .attr('cx', d => projection([d.getAttribute('lon'), d.getAttribute('lat')])[0])
                            .attr('cy', d => projection([d.getAttribute('lon'), d.getAttribute('lat')])[1]);
                    });
                }, 15000);
            };
        </script>
    </body>
</html>